#!/usr/bin/env bash
set -euo pipefail

LAUNCHER="$HOME/RGB-GPUs-Teaming.OP/gnome-launcher.sh"

if [[ ! -x "$LAUNCHER" ]]; then
    echo "Error: launcher not found or not executable: $LAUNCHER" >&2
    exit 2
fi

# Check dependencies
if ! command -v xdg-mime >/dev/null 2>&1; then
    echo "Warning: xdg-mime not found; MIME-based lookup will be skipped" >&2
fi

# Remove desktop Exec field codes like %U %f %F %u %i %c %k
clean_exec_field() {
    local line="$1"
    # Remove leading Exec= if present
    line="${line#Exec=}"
    # Remove field codes and trailing whitespace
    line="$(printf '%s' "$line" | sed -E 's/%[A-Za-z]//g' | sed -E 's/[[:space:]]+$//')"
    printf '%s' "$line"
}

# Resolve desktop file path from desktop id (e.g., org.gnome.Foo.desktop)
find_desktop_path() {
    local desktop_id="$1"
    # search user and system locations; return first match
    find "$HOME/.local/share/applications" /usr/share/applications -maxdepth 2 -type f -name "$desktop_id" 2>/dev/null | head -n1
}

# Process each argument
for raw in "$@"; do
    # Expand tilde and preserve spaces
    file="$raw"

    # If argument is a .desktop id or path
    if [[ "$file" == *.desktop ]]; then
        # If it's a path to an existing file, use it; otherwise treat as desktop id
        if [[ -f "$file" ]]; then
            desktop_path="$file"
        else
            desktop_path="$(find_desktop_path "$file" || true)"
        fi

        if [[ -n "${desktop_path:-}" && -f "$desktop_path" ]]; then
            exec_line="$(grep -m1 -E '^Exec=' "$desktop_path" || true)"
            if [[ -n "$exec_line" ]]; then
                exec_cmd="$(clean_exec_field "$exec_line")"
                echo "Passing command from desktop file to gnome-launcher: $exec_cmd"
                "$LAUNCHER" "$exec_cmd"
            else
                echo "No Exec= line found in $desktop_path" >&2
            fi
        else
            echo "Desktop file not found for $file" >&2
        fi

        continue
    fi

    # If the argument is an executable file (regular file and executable)
    if [[ -f "$file" && -x "$file" ]]; then
        echo "Passing executable file to gnome-launcher: $file"
        "$LAUNCHER" "$file"
        continue
    fi

    # Otherwise try to detect MIME type and find the default desktop entry
    if command -v xdg-mime >/dev/null 2>&1; then
        mime="$(xdg-mime query filetype -- "$file" 2>/dev/null || true)"
    else
        mime=""
    fi

    if [[ -n "$mime" ]]; then
        desktop_id="$(xdg-mime query default -- "$mime" 2>/dev/null || true)"
    else
        desktop_id=""
    fi

    if [[ -n "$desktop_id" ]]; then
        desktop_path="$(find_desktop_path "$desktop_id" || true)"
    else
        desktop_path=""
    fi

    if [[ -n "$desktop_path" && -f "$desktop_path" ]]; then
        exec_line="$(grep -m1 -E '^Exec=' "$desktop_path" || true)"
        if [[ -n "$exec_line" ]]; then
            exec_cmd="$(clean_exec_field "$exec_line")"
            echo "Passing command to gnome-launcher: $exec_cmd"
            "$LAUNCHER" "$exec_cmd"
        else
            echo "No Exec= line found in $desktop_path" >&2
        fi
    else
        # Fallback: if file looks like a command (no path separators), try to pass it directly
        if [[ "$file" != */* ]]; then
            echo "Treating argument as command: $file"
            "$LAUNCHER" "$file"
        else
            echo "Could not find desktop file for MIME type ${mime:-unknown} and argument: $file" >&2
        fi
    fi
done
