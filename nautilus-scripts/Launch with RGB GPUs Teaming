#!/usr/bin/env bash
set -euo pipefail

# Nautilus script: "Launch with RGB GPUs Teaming"
# Place in: ~/.local/share/nautilus/scripts/Launch with RGB GPUs Teaming
# Make executable: chmod +x ~/.local/share/nautilus/scripts/Launch\ with\ RGB\ GPUs\ Teaming

INSTALL_BASE="/opt/RGB-GPUs-Teaming.OP"
LAUNCHER="$INSTALL_BASE/gnome-launcher.sh"

# Ensure launcher exists
if [[ ! -x "$LAUNCHER" ]]; then
  zenity --error --text="Launcher not found or not executable: $LAUNCHER" 2>/dev/null || \
  printf 'Error: launcher not found or not executable: %s\n' "$LAUNCHER" >&2
  exit 2
fi

clean_exec_field() {
  local line="$1"
  line="${line#Exec=}"
  printf '%s' "$line" | sed -E 's/%[A-Za-z]//g' | sed -E 's/[[:space:]]+$//'
}

find_desktop_path() {
  local id="$1"
  local user_apps="$HOME/.local/share/applications"
  if [[ -f "$id" ]]; then
    printf '%s' "$id"
    return
  fi
  if [[ -d "$user_apps" ]]; then
    find "$user_apps" /usr/share/applications -maxdepth 2 -type f -name "$id" 2>/dev/null | head -n1
  else
    find /usr/share/applications -maxdepth 2 -type f -name "$id" 2>/dev/null | head -n1
  fi
}

mime_to_desktop() {
  local file="$1"
  if command -v xdg-mime >/dev/null 2>&1; then
    local mime
    mime="$(xdg-mime query filetype -- "$file" 2>/dev/null || true)"
    if [[ -n "$mime" ]]; then
      xdg-mime query default -- "$mime" 2>/dev/null || true
    fi
  fi
}

run_launcher() {
  local arg="$1"
  "$LAUNCHER" "$arg"
}

# Nautilus passes selected files as args; if none, read stdin
if [[ $# -eq 0 ]]; then
  mapfile -t args < <(sed -n '1,${p;q}' /dev/stdin 2>/dev/null || true)
else
  args=("$@")
fi

for raw in "${args[@]}"; do
  file="${raw/#\~/$HOME}"

  if [[ "$file" == *.desktop ]]; then
    desktop_path="$(find_desktop_path "$file" || true)"
    if [[ -n "$desktop_path" && -f "$desktop_path" ]]; then
      exec_line="$(grep -m1 -E '^Exec=' "$desktop_path" || true)"
      if [[ -n "$exec_line" ]]; then
        exec_cmd="$(clean_exec_field "$exec_line")"
        run_launcher "$exec_cmd"
      else
        printf 'No Exec= line found in %s\n' "$desktop_path" >&2
      fi
    else
      printf 'Desktop file not found for %s\n' "$file" >&2
    fi
    continue
  fi

  if [[ -f "$file" && -x "$file" ]]; then
    run_launcher "$file"
    continue
  fi

  desktop_id="$(mime_to_desktop "$file" || true)"
  if [[ -n "$desktop_id" ]]; then
    desktop_path="$(find_desktop_path "$desktop_id" || true)"
  else
    desktop_path=""
  fi

  if [[ -n "$desktop_path" && -f "$desktop_path" ]]; then
    exec_line="$(grep -m1 -E '^Exec=' "$desktop_path" || true)"
    if [[ -n "$exec_line" ]]; then
      exec_cmd="$(clean_exec_field "$exec_line")"
      run_launcher "$exec_cmd"
      continue
    fi
  fi

  if [[ "$file" != */* ]]; then
    run_launcher "$file"
    continue
  fi

  printf 'Could not resolve: %s\n' "$file" >&2
done

exit 0
